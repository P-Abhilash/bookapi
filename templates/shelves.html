{% extends "boilerplate.html" %}
{% block title %}My Shelves{% endblock %}

{% block content %}
<div class="container py-4">
  <h2>üìö My Shelves</h2>
  {% if error %}
  <div class="alert alert-danger mt-3">{{ error }}</div>
  {% endif %}

  <form class="row g-3 mt-3" method="post" action="/create-shelf">
    <div class="col-auto">
      <input type="text" class="form-control" name="name" placeholder="New shelf name" required maxlength="20"
        oninput="updateCharCount(this)">
      <small id="shelfNameCounter" class="text-muted">0 / 20 characters</small>

    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-primary">‚ûï Create Shelf</button>
    </div>
  </form>

  {% if shelves %}
  <ul class="list-group mt-4">
    {% for shelf in shelves %}
    <li class="list-group-item shelf-item">
      <a href="/shelf/{{ shelf.id }}">{{ shelf.name }}</a>
      <form method="post" action="/delete-shelf" class="delete-shelf-form d-inline" data-shelf="{{ shelf.name }}">
        <input type="hidden" name="shelf_id" value="{{ shelf.id }}">
        <button type="submit" class="btn btn-sm btn-outline-danger">üóëÔ∏è Delete Shelf</button>
      </form>
    </li>
    {% endfor %}
  </ul>
  {% else %}
  <p class="text-muted mt-3">No shelves yet. Add your first one above!</p>
  {% endif %}
</div>

<!-- üóÇÔ∏è Modal: Confirm deleting entire shelf -->
<div class="modal fade" id="confirmShelfDelete" tabindex="-1" aria-labelledby="confirmShelfDeleteLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="confirmShelfDeleteLabel">Delete Shelf</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Deleting the shelf <strong id="shelfDeleteName"></strong> will also remove all books stored inside it.<br><br>
        Are you sure you want to delete this shelf?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmShelfDeleteBtn">Yes, Delete Shelf</button>
      </div>
    </div>
  </div>
</div>

<script>
  let shelfFormToSubmit = null;
  document.querySelectorAll('.delete-shelf-form').forEach(form => {
    form.addEventListener('submit', e => {
      e.preventDefault();
      shelfFormToSubmit = form;

      // dynamically insert shelf name
      const shelfName = form.dataset.shelf;
      document.getElementById('shelfDeleteName').textContent = `"${shelfName}"`;

      const modal = new bootstrap.Modal(document.getElementById('confirmShelfDelete'));
      modal.show();

      document.getElementById('confirmShelfDeleteBtn').onclick = () => {
        modal.hide();
        shelfFormToSubmit.submit();
      };
    });
  });
</script>
<script>
  function updateCharCount(input) {
    const counter = document.getElementById("shelfNameCounter");
    counter.textContent = `${input.value.length} / 20 characters`;
  }
</script>
{% endblock %}