{% extends "boilerplate.html" %}
{% block title %}{{ book.volumeInfo.title }}{% endblock %}

{% block content %}
<div class="container py-4 book-detail-page">
  <div class="book-layout">

    <!-- === LEFT COLUMN (Desktop) / ALL STACKED (Mobile) === -->
    <div class="book-sidebar">
      <!-- üìò Thumbnail -->
      <!-- üìò Thumbnail -->
      <div class="text-center mb-3">
        {% if book.volumeInfo.imageLinks and book.volumeInfo.imageLinks.thumbnail %}
        <img src="{{ book.volumeInfo.imageLinks.thumbnail }}" class="img-fluid mx-auto d-block" alt="Book cover">
        {% endif %}
      </div>

      <!-- üìÑ Basic Book Info -->
      <div class="book-meta mt-3">
        <h2 class="book-title-mobile d-lg-none">{{ book.volumeInfo.title }}</h2>
        {% if book.volumeInfo.authors %}
        <p><strong>Author:</strong> {{ book.volumeInfo.authors | join(', ') }}</p>
        {% endif %}
        {% if book.volumeInfo.publishedDate %}
        <p><strong>Published:</strong> {{ book.volumeInfo.publishedDate }}</p>
        {% endif %}
        {% if book.volumeInfo.categories %}
        <p><strong>Categories:</strong> {{ book.volumeInfo.categories | join(', ') }}</p>
        {% endif %}
        {% if book.volumeInfo.language %}
        <p><strong>Language:</strong> {{ book.volumeInfo.language | upper }}</p>
        {% endif %}
      </div>

      <!-- üìñ Description -->
      <div class="book-description-mobile d-lg-none mt-3">
        <h5><strong>Description</strong></h5>
        <p>{{ book.volumeInfo.description | safe }}</p>
      </div>

      <!-- ‚ù§Ô∏è Favorite (AJAX) -->
      <div class="book-favorite">
        <button id="favoriteBtn" class="btn btn-{{ 'danger' if is_favorite else 'primary' }} w-auto mt-2"
          data-bookid="{{ book.id }}" data-title="{{ book.volumeInfo.title }}"
          data-authors="{{ book.volumeInfo.authors | join(', ') }}"
          data-thumbnail="{{ book.volumeInfo.imageLinks.thumbnail if book.volumeInfo.imageLinks }}"
          data-favorite="{{ 'true' if is_favorite else 'false' }}">
          {{ '‚ù§Ô∏è Remove from Favorites' if is_favorite else 'Add to Favorites ‚ù§Ô∏è' }}
        </button>
      </div>


      <!-- üìÅ Shelves -->
      {% if user %}
      <hr>
      <h5>Add this book to a shelf:</h5>
      <div class="book-shelves">
        {% if shelves %}
        {% for shelf in shelves %}
        {% set in_shelf = shelf.id in shelf_books %}
        <button class="btn btn-sm w-auto mb-1 shelf-btn
                 {{ 'btn-warning' if in_shelf else 'btn-success text-white' }}" data-shelfid="{{ shelf.id }}"
          data-bookid="{{ book.id }}" data-title="{{ book.volumeInfo.title }}"
          data-authors="{{ book.volumeInfo.authors | join(', ') }}"
          data-thumbnail="{{ book.volumeInfo.imageLinks.thumbnail if book.volumeInfo.imageLinks }}"
          data-shelfname="{{ shelf.name }}" data-inshelf="{{ 'true' if in_shelf else 'false' }}">
          {{ 'Remove from "' ~ shelf.name ~ '"' if in_shelf else '+ "' ~ shelf.name ~ '"' }}
        </button>
        {% endfor %}
        {% else %}
        <p class="text-muted">No shelves yet.</p>
        {% endif %}
        <button type="button" class="btn btn-outline-dark btn-sm w-auto mt-2" data-bs-toggle="modal"
          data-bs-target="#createShelfModal">
          + Create New Shelf
        </button>
      </div>
      {% endif %}

      <!-- üõí Where to Read or Buy -->
      {% if book.saleInfo or book.accessInfo %}
      <hr>
      <h5>üìñ Where to Read or Buy</h5>
      <div class="buy-read-section">
        {% if book.saleInfo.isEbook %}
        <p><strong>Available as eBook</strong></p>
        {% endif %}
        {% if book.saleInfo.retailPrice %}
        <p>üí≤ <strong>{{ book.saleInfo.retailPrice.amount }} {{ book.saleInfo.retailPrice.currencyCode }}</strong></p>
        {% endif %}
        {% if book.saleInfo.buyLink %}
        <a href="{{ book.saleInfo.buyLink }}" target="_blank" class="btn btn-success mb-2 w-auto">
          üõí Buy on Google Play
        </a>
        {% endif %}
        {% if book.accessInfo.webReaderLink %}
        <a href="{{ book.accessInfo.webReaderLink }}" target="_blank" class="btn btn-outline-primary mb-2 w-auto">
          üìö Read Online
        </a>
        {% endif %}
        {% if not book.saleInfo.buyLink and not book.accessInfo.webReaderLink %}
        <p class="text-muted">No purchase or online reading links available.</p>
        {% endif %}
      </div>
      {% endif %}
      <!-- üõçÔ∏è Other Stores -->
      {% if other_links %}
      <hr>
      <h5>üõçÔ∏è Also Available On</h5>
      <div class="buy-read-section">
        {% for name, url in other_links.items() %}
        <a href="{{ url }}" target="_blank" class="btn btn-outline-secondary mb-2 w-auto">
          {{ name }}
        </a>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <!-- === RIGHT COLUMN (Desktop Description) === -->
    <div class="book-description d-none d-lg-block">
      <h2>{{ book.volumeInfo.title }}</h2>
      <p>{{ book.volumeInfo.description | safe }}</p>
    </div>
  </div>
</div>

<!-- üìö Create Shelf Modal -->
<div class="modal fade" id="createShelfModal" tabindex="-1" aria-labelledby="createShelfLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="/create-shelf">
        <div class="modal-header">
          <h5 class="modal-title" id="createShelfLabel">Create a New Shelf</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="shelfName" class="form-label">Shelf Name</label>
            <input type="text" name="name" id="shelfName" class="form-control"
              placeholder="e.g. Favorites, Sci-Fi, To Read" required maxlength="20"
              oninput="updateShelfCharCount(this)">
            <small id="shelfCharCounter" class="text-muted">0 / 20 characters</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Shelf</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ‚úÖ Toast Notification using Bootstrap positioning -->
<div class="toast-container position-fixed top-0 end-0 p-3 mt-5" style="z-index: 1100;">
  <div id="actionToast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive"
    aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastText">Action completed</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
        aria-label="Close"></button>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // === Toast helper ===
    const toastEl = document.getElementById("actionToast");
    const toastBody = document.getElementById("toastText");
    const toast = new bootstrap.Toast(toastEl, { delay: 2200 });

    function showToast(msg, color = "dark") {
      toastEl.className = `toast align-items-center text-bg-${color} border-0`;
      toastBody.textContent = msg;
      toast.show();
    }

    // === Favorites toggle ===
    const favBtn = document.getElementById("favoriteBtn");
    if (favBtn) {
      favBtn.addEventListener("click", async () => {
        favBtn.disabled = true;
        const isFav = favBtn.dataset.favorite === "true";
        const payload = {
          book_id: favBtn.dataset.bookid,
          title: favBtn.dataset.title,
          authors: favBtn.dataset.authors,
          thumbnail: favBtn.dataset.thumbnail,
          is_favorite: isFav
        };
        const res = await fetch("/favorite-json", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        favBtn.disabled = false;

        if (data.success) {
          favBtn.dataset.favorite = (!isFav).toString();
          favBtn.textContent = isFav ? "Add to Favorites ‚ù§Ô∏è" : "‚ù§Ô∏è Remove from Favorites";
          favBtn.classList.toggle("btn-danger");
          favBtn.classList.toggle("btn-primary");
          showToast(isFav ? "üíî Removed from Favorites" : "üíñ Added to Favorites",
            isFav ? "secondary" : "success");
        } else {
          showToast("‚ö†Ô∏è Please log in", "danger");
        }
      });
    }

    // === Shelf toggle ===
    document.querySelectorAll(".shelf-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        btn.disabled = true;
        const inShelf = btn.dataset.inshelf === "true";
        const payload = {
          shelf_id: btn.dataset.shelfid,
          book_id: btn.dataset.bookid,
          title: btn.dataset.title,
          authors: btn.dataset.authors,
          thumbnail: btn.dataset.thumbnail,
          in_shelf: inShelf
        };
        const res = await fetch("/shelf-json", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        btn.disabled = false;

        if (data.success) {
          btn.dataset.inshelf = (!inShelf).toString();
          btn.classList.toggle("btn-success");
          btn.classList.toggle("btn-warning");
          btn.textContent = inShelf
            ? `+ "${btn.dataset.shelfname}"`
            : `Remove from "${btn.dataset.shelfname}"`;
          showToast(inShelf
            ? `üìï Removed from ${btn.dataset.shelfname}`
            : `üìò Added to ${btn.dataset.shelfname}`,
            inShelf ? "secondary" : "success");
        } else {
          showToast("‚ö†Ô∏è Unable to update shelf", "danger");
        }
      });
    });
  });
</script>
<script>
  function updateShelfCharCount(input) {
    const counter = document.getElementById("shelfCharCounter");
    if (counter) counter.textContent = `${input.value.length} / 20 characters`;
  }
</script>

{% endblock %}